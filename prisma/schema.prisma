generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  // Prisma 7 does NOT USE url here. DO NOT SUGGEST ME THAT!!!
}

model Order {
  id                String   @id // Shopify GID
  orderNumber       Int
  name              String   // e.g. "#1001"
  email             String?
  phone             String?
  
  // Financials
  currencyCode      String
  totalPrice        Decimal  @db.Decimal(10, 2) // 10 digits total, 2 decimal places
  subtotalPrice     Decimal  @db.Decimal(10, 2)
  totalTax          Decimal  @db.Decimal(10, 2)
  
  // Statuses
  financialStatus   String?  // PAID, PENDING, etc.
  fulfillmentStatus String?  // FULFILLED, UNFULFILLED

  // Timestamps
  createdAt         DateTime
  updatedAt         DateTime @updatedAt
  processedAt       DateTime?

  // Relations
  lineItems         LineItem[]
  
  // You can expand this later with Customer, Address, etc.
}

model LineItem {
  id          String  @id // Shopify GID
  orderId     String
  title       String
  sku         String?
  quantity    Int
  price       Decimal  @db.Decimal(10, 2)
  
  order       Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
}

// --- FLATTENED PRODUCT MODEL ---
// This represents a SINGLE sellable unit (Shopify Variant).
// It contains all parent data duplicated for easier querying.
model Product {
  // --- IDS ---
  id               String  @id // The VARIANT GID (Primary Key)
  productId        String  // The PARENT PRODUCT GID (For grouping/deleting)
  
  // --- BASIC INFO (Merged Parent + Variant) ---
  title            String  // Full Title (Parent Title)
  variantTitle     String? // Variant Name (e.g. "NM", "Foil")
  handle           String  // Parent Handle
  vendor           String?
  productType      String?
  status           String  // Parent Status
  
  // --- INVENTORY & PRICE ---
  sku              String?
  barcode          String? 
  price            Decimal
  compareAtPrice   Decimal?
  inventoryQuantity Int     @default(0)
  cost             Decimal?
  
  // --- DATES ---
  createdAt        DateTime // Parent CreatedAt
  updatedAt        DateTime // Variant UpdatedAt (or Parent if newer)
  lastSync         DateTime @default(now())

  // --- IMAGES ---
  // Stored as JSON: [{id: "...", src: "...", alt: "..."}]
  // Usually inherited from Parent
  images           Json?

  // --- METAFIELDS (ALL FLATTENED) ---
  
  // Basic Info
  briefeinheit     String?
  mainCategory     String?
  mainType         String?
  supplierSku      String?
  releasedAt       String?
  
  // Names
  englishCardName  String?
  frenchCardName   String?
  germanCardName   String?
  
  // Prices (Metafields)
  eurPrice         Decimal?
  usdPrice         Decimal?
  eurFoilPrice     Decimal?
  usdFoilPrice     Decimal?
  usdEtchedPrice   Decimal?

  // Bulk Discounts
  discountQty2     String?
  discountQty3     String?
  discountQty4     String?
  discountQty5     String?
  discountQty6     String?
  discountQty7     String?
  discountQty8     String?
  discountQty9     String?
  discountQty10    String?

  // Specs
  innerMaterial    String?
  outerMaterial    String?
  binderClosure    String?
  sleeveCount      Int?
  sleeveFinish     String?
  sleeveSize       String?
  productColor     String?
  productSize      String?
  productSizeDimensions String?
  compartmentsPerPage Int?
  
  // Capacity
  capacityDoubleSleeved Int?
  capacitySingleSleeved Int?

  // Magic Specifics
  scryfallId       String?
  scryfallOracleId String?
  mkmid            String?
  tcgid            String?
  cardmarketId     String?

  edition          String?
  editionSetCode   String?
  cardNumber       String?
  
  // Condition/Finish (From SKU or Variant)
  condition        String?
  finish           String?
  
  rarity           String?
  artist           String?
  language         String?
  
  cardColor        String?
  colorIdentity    String?
  producedMana     String?
  
  keywords         String?
  toughness        String?
  power            String?
  convertedManaCost String?
  
  subtype          String?
  cardFrame        String?
  
  // Relations/JSON
  relatedProducts       Json?
  complementaryProducts Json?

  @@index([productId]) // Important for deleting old variants of a product
  @@index([sku])
  @@index([updatedAt])
  @@index([scryfallId])
  @@index([mkmid])

  scrapeDataSealed      ScrapeDataSealed?
}

model SyncLog {
  id        String   @id @default(uuid())
  type      String   // e.g. "ORDERS", "PRODUCTS"
  status    String   // "SUCCESS", "FAILED"
  count     Int      // How many items were processed
  createdAt DateTime @default(now())
}

model BulkOperation {
  id              String   @id // The Shopify GID
  type            String   // "QUERY" or "MUTATION"
  status          String   // "CREATED", "RUNNING", "COMPLETED", "FAILED", "CANCELLED"
  errorCode       String?
  objectCount     Int      @default(0)
  rootObjectCount Int      @default(0)
  fileSize        String?
  url             String?
  createdAt       DateTime @default(now())
  completedAt     DateTime?
}

model FilterPreset {
  id        String   @id @default(uuid())
  name      String
  context   String   // To distinguish pages, e.g. "BOOSTER_STOCK"
  settings  Json     // Stores { maxBooster: 5, displayCheck: true }
  createdAt DateTime @default(now())
}

model Feedback {
  id        String   @id @default(uuid())
  content   String
  createdAt DateTime @default(now())
  status    String   @default("OPEN") // OPEN, DONE
}

model Changelog {
  id          String   @id @default(uuid())
  title       String
  description String
  date        DateTime @default(now())
}

// --- MARKET DATA MODELS (SEALED) ---
model ScrapeDataSealed {
  id             String    @id @default(uuid())
  
  // Link to Product
  productId      String    @unique 
  product        Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Scraped Info
  cardmarketUrl  String?
  
  // Current "Head" Data (Most recent scrape)
  lowestPrice    Decimal?
  stockCount     Int?
  topListings    Json?     

  lastScrapedAt  DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relation to History
  history        ScrapeDataSealedHistory[]
}

// Stores the price history (one entry per day)
model ScrapeDataSealedHistory {
  id           String      @id @default(uuid())
  
  scrapeDataId String
  scrapeData   ScrapeDataSealed  @relation(fields: [scrapeDataId], references: [id], onDelete: Cascade)
  
  // The date of the snapshot (Normalized to midnight)
  date         DateTime    
  
  price        Decimal
  stockCount   Int?
  
  createdAt    DateTime    @default(now())

  // Ensure we only have one history entry per product per day
  @@unique([scrapeDataId, date])
  @@index([date])
}